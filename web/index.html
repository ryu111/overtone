<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Overtone Dashboard</title>
  <link rel="stylesheet" href="/static/main.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
</head>
<body x-data="indexState()">

  <!-- Header -->
  <header>
    <div class="logo">ğŸµ Overtone</div>
    <div class="header-spacer"></div>
    <div class="connection-status" :class="connected ? 'online' : ''">
      <span x-text="connected ? 'å·²é€£ç·š' : 'é€£ç·šä¸­...'"></span>
    </div>
  </header>

  <main>
    <h1>å·¥ä½œéšæ®µ</h1>

    <!-- é€²è¡Œä¸­ -->
    <section>
      <h2>â³ é€²è¡Œä¸­ <span style="font-weight:normal; font-size:0.85rem">({{ACTIVE_COUNT}})</span></h2>
      <div id="active-sessions">{{ACTIVE_SESSIONS}}</div>
    </section>

    <!-- æ­·å²ç´€éŒ„ -->
    <section>
      <h2>ğŸ“‹ æ­·å²ç´€éŒ„ <span style="font-weight:normal; font-size:0.85rem">({{HISTORY_COUNT}})</span></h2>
      <div id="history-sessions">{{HISTORY_SESSIONS}}</div>
    </section>
  </main>

  <script>
  function indexState() {
    return {
      connected: false,
      eventSource: null,

      init() {
        this.connectSSE();
      },

      connectSSE() {
        if (this.eventSource) {
          this.eventSource.close();
        }

        const es = new EventSource('/sse/all');

        es.addEventListener('connected', () => {
          this.connected = true;
        });

        es.addEventListener('workflow', () => {
          // æ”¶åˆ°å·¥ä½œæµæ›´æ–°æ™‚é‡æ–°è¼‰å…¥é é¢ä»¥åˆ·æ–° session åˆ—è¡¨
          // ç°¡å–®æ–¹æ¡ˆï¼šç›´æ¥ reloadï¼ˆä½é »äº‹ä»¶ï¼Œä¸å½±éŸ¿é«”é©—ï¼‰
          location.reload();
        });

        es.addEventListener('heartbeat', () => {
          this.connected = true;
        });

        es.onerror = () => {
          this.connected = false;
          if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
          }
          setTimeout(() => this.connectSSE(), 3000);
        };

        this.eventSource = es;
      },

      destroy() {
        if (this.eventSource) {
          this.eventSource.close();
        }
      },
    };
  }
  </script>

</body>
</html>
