# è³‡æ–™åº«å¯©æŸ¥ä¸‰ç¶­åº¦æ¸…å–®

> ğŸ“‹ **ä½•æ™‚è®€å–**ï¼šåŸ·è¡Œè³‡æ–™åº«å¯©æŸ¥æˆ–éœ€è¦å®Œæ•´æª¢æŸ¥é …ç›®æ™‚ã€‚

## ç¶­åº¦ä¸€ï¼šæ•ˆèƒ½

### N+1 æŸ¥è©¢åµæ¸¬

**ä½•è¬‚ N+1**ï¼šæŸ¥è©¢ 1 æ¬¡å–å¾—æ¸…å–®ï¼Œå†å°æ¯ç­†è³‡æ–™å„æŸ¥è©¢ 1 æ¬¡å–å¾—é—œè¯ã€‚

```
// âŒ N+1ï¼ˆ1 + N æ¬¡æŸ¥è©¢ï¼‰
const posts = await Post.findAll();
for (const post of posts) {
  post.author = await User.findById(post.authorId);
}

// âœ… Eager loadingï¼ˆ1-2 æ¬¡æŸ¥è©¢ï¼‰
const posts = await Post.findAll({
  include: [{ model: User, as: 'author' }],
});
```

**åµæ¸¬æ–¹æ³•**ï¼š
- [ ] è¿´åœˆä¸­æœ‰ `await` æŸ¥è©¢ â†’ é«˜åº¦å¯ç–‘
- [ ] ORM `findById` / `findOne` åœ¨ loop ä¸­å‘¼å«
- [ ] GraphQL resolver æ²’æœ‰ä½¿ç”¨ DataLoader

### ç¼ºå°‘ç´¢å¼•

**æª¢æŸ¥è¦é»**ï¼š
- [ ] WHERE å­å¥ä¸­çš„æ¬„ä½æ˜¯å¦æœ‰ç´¢å¼•
- [ ] JOIN çš„å¤–éµæ¬„ä½æ˜¯å¦æœ‰ç´¢å¼•
- [ ] ORDER BY çš„æ’åºæ¬„ä½ï¼ˆé«˜é »æŸ¥è©¢ï¼‰
- [ ] è¤‡åˆæŸ¥è©¢æ˜¯å¦æœ‰è¤‡åˆç´¢å¼•

**ç´¢å¼•å»ºè­°åŸå‰‡**ï¼š
- å–®ä¸€æ¬„ä½é«˜é¸æ“‡æ€§ â†’ B-tree ç´¢å¼•
- æ–‡å­—æœå°‹ â†’ Full-text æˆ– GIN ç´¢å¼•
- JSON æ¬„ä½æŸ¥è©¢ â†’ GIN ç´¢å¼•
- å¸ƒæ—/åˆ—èˆ‰æ¬„ä½ â†’ éƒ¨åˆ†ç´¢å¼•ï¼ˆpartial indexï¼‰
- é¿å…éåº¦ç´¢å¼•ï¼šå¯«å…¥æ•ˆèƒ½ä¸‹é™ã€å„²å­˜ç©ºé–“å¢åŠ 

### æ…¢æŸ¥è©¢åˆ†æ

- [ ] SELECT * æ˜¯å¦å¯ä»¥æ”¹ç‚ºåªé¸éœ€è¦çš„æ¬„ä½
- [ ] å¤§è¡¨ JOIN æ˜¯å¦æœ‰é©ç•¶ç´¢å¼•
- [ ] å­æŸ¥è©¢æ˜¯å¦å¯ä»¥æ”¹ç‚º JOIN
- [ ] LIKE '%keyword%' å‰ç¶´è¬ç”¨å­—å…ƒç„¡æ³•ä½¿ç”¨ç´¢å¼•
- [ ] DISTINCT / GROUP BY æ˜¯å¦å¿…è¦
- [ ] åˆ†é ä½¿ç”¨ OFFSET åœ¨å¤§è¡¨æ•ˆèƒ½å·® â†’ æ”¹ç”¨ cursor-based

### æ•ˆèƒ½å½±éŸ¿è©•ä¼°

| åš´é‡ç¨‹åº¦ | æ¢ä»¶ |
|:--------:|------|
| ğŸ”´ Critical | N+1 åœ¨ä¸»è¦åˆ—è¡¨ API ä¸­ |
| ğŸŸ  High | ç¼ºå°‘å¤–éµç´¢å¼• + è¡¨è¶…é 10 è¬è¡Œ |
| ğŸŸ¡ Medium | SELECT * åœ¨è¤‡é›œ JOIN ä¸­ |
| ğŸ”µ Low | éæ ¸å¿ƒè·¯å¾‘çš„è¼•å¾®æ•ˆèƒ½å•é¡Œ |

## ç¶­åº¦äºŒï¼šå®‰å…¨æ€§

### SQL Injection é˜²è­·

- [ ] æ‰€æœ‰æŸ¥è©¢ä½¿ç”¨ parameterized query æˆ– ORM
- [ ] ä¸ä½¿ç”¨å­—ä¸²æ‹¼æ¥å»ºæ§‹ SQL
- [ ] å‹•æ…‹ ORDER BY/WHERE æ¬„ä½ä½¿ç”¨ç™½åå–®é©—è­‰
- [ ] Raw query æœ‰æ­£ç•¶ç†ç”±ä¸”å·² review

```
// âŒ å‹•æ…‹æ’åºæ¬„ä½æœªé©—è­‰
const order = req.query.sortBy;
const sql = `SELECT * FROM users ORDER BY ${order}`;

// âœ… ç™½åå–®é©—è­‰
const ALLOWED_SORT = ['name', 'created_at', 'email'];
const order = ALLOWED_SORT.includes(req.query.sortBy)
  ? req.query.sortBy
  : 'created_at';
```

### Migration å®‰å…¨æ€§

**å¯é€†æ€§æª¢æŸ¥**ï¼š
- [ ] æ¯å€‹ `up` migration æœ‰å°æ‡‰çš„ `down`
- [ ] çµæ§‹æ€§è®Šæ›´ï¼ˆåŠ æ¬„ä½ï¼‰å¯å›æ»¾
- [ ] è³‡æ–™å¡«å……ï¼ˆseed/backfillï¼‰æœ‰æ¸…ç†é‚è¼¯

**ç ´å£æ€§è®Šæ›´**ï¼š
- [ ] åˆªé™¤æ¬„ä½/è¡¨ â†’ æ˜¯å¦å…ˆåšè»Ÿåˆªé™¤ï¼ˆrename + deprecation periodï¼‰
- [ ] æ¬„ä½é‡æ–°å‘½å â†’ æ˜¯å¦ä½¿ç”¨ alias ä¿æŒå‘å¾Œç›¸å®¹
- [ ] æ¬„ä½é¡å‹è®Šæ›´ â†’ æ˜¯å¦æœƒå°è‡´è³‡æ–™éºå¤±
- [ ] NOT NULL ç´„æŸ â†’ ç¾æœ‰è³‡æ–™æ˜¯å¦éƒ½æœ‰å€¼

**ä¸Šç·šç­–ç•¥**ï¼š
- [ ] å¤§è¡¨ DDL æ˜¯å¦ä½¿ç”¨ online DDLï¼ˆé¿å…é–è¡¨ï¼‰
- [ ] è³‡æ–™å›å¡«æ˜¯å¦åˆ†æ‰¹åŸ·è¡Œï¼ˆé¿å…é•·æ™‚é–“é–å®šï¼‰
- [ ] æ˜¯å¦æœ‰å›æ»¾è¨ˆç•«

### æ¬Šé™èˆ‡å­˜å–æ§åˆ¶

- [ ] è³‡æ–™åº«å¸³è™Ÿä½¿ç”¨æœ€å°æ¬Šé™åŸå‰‡
- [ ] æ•æ„Ÿè³‡æ–™ï¼ˆå¯†ç¢¼ã€tokenï¼‰åŠ å¯†å„²å­˜
- [ ] ä½¿ç”¨è€…è³‡æ–™æŸ¥è©¢æœ‰ row-level å­˜å–æ§åˆ¶

## ç¶­åº¦ä¸‰ï¼šæœ€ä½³å¯¦è¸

### Transaction é‚Šç•Œ

- [ ] å¤šæ­¥é©Ÿæ“ä½œåŒ…è£åœ¨ transaction ä¸­
- [ ] Transaction ç¯„åœæœ€å°åŒ–ï¼ˆä¸åŒ…å«é DB æ“ä½œå¦‚ API å‘¼å«ï¼‰
- [ ] å·¢ç‹€ transaction ä½¿ç”¨ savepoint
- [ ] éŒ¯èª¤æ™‚æ­£ç¢º rollback

```
// âœ… æ­£ç¢ºçš„ transaction ä½¿ç”¨
const result = await db.transaction(async (trx) => {
  const order = await Order.create({ userId, total }, { transaction: trx });
  await OrderItem.bulkCreate(items, { transaction: trx });
  await Inventory.decrement(items, { transaction: trx });
  return order;
});

// Transaction å¤–ï¼šç™¼é€é€šçŸ¥ï¼ˆé DB æ“ä½œï¼‰
await sendOrderConfirmation(result.id);
```

### Connection Pool ç®¡ç†

- [ ] Pool size åˆç†è¨­å®šï¼ˆå»ºè­°ï¼š`CPU cores * 2 + disk spindles`ï¼‰
- [ ] é–’ç½®é€£ç·šè¶…æ™‚è¨­å®š
- [ ] é€£ç·šæ´©æ¼åµæ¸¬ï¼ˆé•·æ™‚é–“æŒæœ‰çš„é€£ç·šï¼‰
- [ ] è®€å¯«åˆ†é›¢ï¼ˆread replicaï¼‰è¨­å®š

### Lock å½±éŸ¿

- [ ] é•· transaction æ˜¯å¦å°è‡´è¡Œé–/è¡¨é–
- [ ] SELECT FOR UPDATE çš„ä½¿ç”¨æ˜¯å¦åˆç†
- [ ] Deadlock é¢¨éšªï¼šå¤šå€‹ transaction æ˜¯å¦ä»¥ä¸€è‡´çš„é †åºå­˜å–è³‡æº
- [ ] Advisory lock çš„ä½¿ç”¨å’Œé‡‹æ”¾æ˜¯å¦é…å°

### å…¶ä»–æœ€ä½³å¯¦è¸

- [ ] æ¬„ä½å‘½åä¸€è‡´ï¼ˆsnake_case / camelCaseï¼‰
- [ ] created_at / updated_at æ™‚é–“æˆ³
- [ ] è»Ÿåˆªé™¤ vs ç¡¬åˆªé™¤ç­–ç•¥ä¸€è‡´
- [ ] UUID vs auto-increment ä¸»éµç­–ç•¥
- [ ] æ¬„ä½æœ‰é©ç•¶çš„ NOT NULL / DEFAULT ç´„æŸ

## å¯©æŸ¥å ±å‘Šæ ¼å¼

```markdown
## DB å¯©æŸ¥å ±å‘Š

### æ‘˜è¦
- å¯©æŸ¥ç¯„åœï¼š[æè¿°]
- åˆ¤å®šï¼šPASS / REJECT

### æ•ˆèƒ½å•é¡Œ
[æŒ‰åš´é‡ç¨‹åº¦åˆ—å‡º]

### å®‰å…¨å•é¡Œ
[æŒ‰åš´é‡ç¨‹åº¦åˆ—å‡º]

### æœ€ä½³å¯¦è¸å»ºè­°
[æŒ‰å„ªå…ˆé †åºåˆ—å‡º]
```
